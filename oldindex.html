<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Count - Roller Coaster Tracker</title>
	<link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="header">
        <h1>Credit Counter</h1>
        <p>Rollercoaster cred counter by theminemat</p>
    </div>

    <div class="user-profile">
        <div class="profile-icon">T</div>
        <div class="profile-info">
            <div class="profile-name" id="username">theminemat</div>
            <div class="profile-stats" id="profile-stats">Loading stats...</div>
        </div>
    </div>

    <div class="stats">
        <div class="stat-card">
            <h3 id="total-coasters">0</h3>
            <p>Coasters</p>
        </div>
        <div class="stat-card">
            <h3 id="total-parks">0</h3>
            <p>Parks</p>
        </div>
        <div class="stat-card">
            <h3 id="total-rides">0</h3>
            <p>Total Rides</p>
        </div>
        <div class="stat-card">
            <h3 id="top-manufacturer">-</h3>
            <p>Top Manufacturer</p>
        </div>
    </div>

    <div class="search-filter">
        <input type="text" class="search-bar" placeholder="Search coasters..." id="search-input">
        <select class="filter-select" id="park-filter">
            <option value="">All Parks</option>
        </select>
        <select class="filter-select" id="manufacturer-filter">
            <option value="">All Manufacturers</option>
        </select>
    </div>

    <div id="loader-container" class="loader-container">
        <div class="loader">
            <div class="loader-inner one"></div>
            <div class="loader-inner two"></div>
            <div class="loader-inner three"></div>
            <div class="loader-text">Loading roller coasters...</div>
        </div>
    </div>

    <div id="error-message" class="error-message" style="display: none;"></div>
    <div id="coaster-grid" class="coaster-grid"></div>
	<script>
// Configuration
const API_URL = "https://script.google.com/macros/s/AKfycbwtLoYodTRSDqQjYQQrpysEzfKqJCNLOyRYSqzzBZfe2PXZuqikxt43KaEFpyNqo0SZnQ/exec";
const USERNAME = "theminemat"; // This could later be made configurable or stored in localStorage

// Elements
const loaderContainer = document.getElementById('loader-container');
const errorMessage = document.getElementById('error-message');
const coasterGrid = document.getElementById('coaster-grid');
const searchInput = document.getElementById('search-input');
const parkFilter = document.getElementById('park-filter');
const manufacturerFilter = document.getElementById('manufacturer-filter');
const totalCoastersElement = document.getElementById('total-coasters');
const totalParksElement = document.getElementById('total-parks');
const totalRidesElement = document.getElementById('total-rides');
const topManufacturerElement = document.getElementById('top-manufacturer');
const profileStatsElement = document.getElementById('profile-stats');
const usernameElement = document.getElementById('username');

// Global data store
let allCoasters = [];

// Initialization
document.addEventListener('DOMContentLoaded', () => {
    console.log("App initialized, loading data for user:", USERNAME);
    usernameElement.textContent = USERNAME;
    
    fetchCoasterData();
    
    // Set up event listeners
    searchInput.addEventListener('input', filterCoasters);
    parkFilter.addEventListener('change', filterCoasters);
    manufacturerFilter.addEventListener('change', filterCoasters);
});

// Fetch data from API
function fetchCoasterData() {
    // Show loader
    loaderContainer.style.display = 'flex';
    
    // Fetch data from the provided API
    const apiUrl = `${API_URL}?user=${USERNAME}`;
    console.log("Fetching data from:", apiUrl);
    
    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("Data received:", data);
            
            if (!data || data.length === 0) {
                throw new Error('No coaster data found for this user');
            }
            
            // Store the data
            allCoasters = data;
            
            // Process and display the data
            updateFilterOptions();
            updateStats(allCoasters);
            displayCoasters(allCoasters);
            
            // Hide loader
            loaderContainer.style.display = 'none';
        })
        .catch(error => {
            console.error('Error fetching data:', error);
            
            // Hide loader
            loaderContainer.style.display = 'none';
            
            // Show error message
            errorMessage.textContent = `Error loading data: ${error.message}`;
            errorMessage.style.display = 'block';
        });
}

// Update filter options based on available data
function updateFilterOptions() {
    // Clear existing options (keep the first "All" option)
    while (parkFilter.options.length > 1) parkFilter.remove(1);
    while (manufacturerFilter.options.length > 1) manufacturerFilter.remove(1);
    
    // Get unique parks and manufacturers
    const parks = [...new Set(allCoasters.map(c => c.Park).filter(Boolean))].sort();
    const manufacturers = [...new Set(allCoasters.map(c => c.Manufacteuer).filter(Boolean))].sort();
    
    // Add options to filters
    parks.forEach(park => {
        const option = document.createElement('option');
        option.value = park;
        option.textContent = park;
        parkFilter.appendChild(option);
    });
    
    manufacturers.forEach(manufacturer => {
        const option = document.createElement('option');
        option.value = manufacturer;
        option.textContent = manufacturer;
        manufacturerFilter.appendChild(option);
    });
}

// Update statistics based on coaster data
function updateStats(coasters) {
    // Count total coasters
    totalCoastersElement.textContent = coasters.length;
    
    // Count unique parks
    const uniqueParks = new Set(coasters.map(c => c.Park).filter(Boolean));
    totalParksElement.textContent = uniqueParks.size;
    
    // Calculate total rides
    const totalRides = coasters.reduce((sum, coaster) => sum + (parseInt(coaster.Ride) || 0), 0);
    totalRidesElement.textContent = totalRides;
    
    // Find top manufacturer
    const manufacturerCounts = {};
    coasters.forEach(coaster => {
        const manufacturer = coaster.Manufacteuer;
        if (manufacturer) {
            manufacturerCounts[manufacturer] = (manufacturerCounts[manufacturer] || 0) + 1;
        }
    });
    
    let topManufacturer = '-';
    let maxCount = 0;
    
    for (const [manufacturer, count] of Object.entries(manufacturerCounts)) {
        if (count > maxCount) {
            maxCount = count;
            topManufacturer = manufacturer;
        }
    }
    
    topManufacturerElement.textContent = topManufacturer;
    
    // Update profile stats
    profileStatsElement.textContent = `${coasters.length} coasters in ${uniqueParks.size} parks`;
}

// Display coasters in the grid
function displayCoasters(coasters) {
    // Clear the grid
    coasterGrid.innerHTML = '';
    
    if (coasters.length === 0) {
        errorMessage.textContent = 'No coasters found matching your criteria';
        errorMessage.style.display = 'block';
        return;
    }
    
    // Hide any error message
    errorMessage.style.display = 'none';
    
    // Sort coasters by park name
    coasters.sort((a, b) => {
        if (a.Park !== b.Park) return a.Park.localeCompare(b.Park);
        return a.Name.localeCompare(b.Name);
    });
    
    // Create a card for each coaster
    coasters.forEach(coaster => {
        const card = document.createElement('div');
        card.className = 'coaster-card';
        
        // Create the image section or placeholder
        const imageDiv = document.createElement('div');
        imageDiv.className = 'coaster-image';
        
        if (coaster.ImgUrl) {
            imageDiv.style.backgroundImage = `url(${coaster.ImgUrl})`;
        } else {
            imageDiv.classList.add('no-image');
            imageDiv.textContent = 'No Image';
        }
        
        // Add ride count badge if applicable
        if (coaster.Ride && parseInt(coaster.Ride) > 0) {
            const rideCount = document.createElement('div');
            rideCount.className = 'ride-count';
            rideCount.textContent = `${coaster.Ride}x`;
            imageDiv.appendChild(rideCount);
        }
        
        // Create details section
        const detailsDiv = document.createElement('div');
        detailsDiv.className = 'coaster-details';
        
        const nameDiv = document.createElement('div');
        nameDiv.className = 'coaster-name';
        nameDiv.textContent = coaster.Name || 'Unknown Coaster';
        
        const parkDiv = document.createElement('div');
        parkDiv.className = 'coaster-park';
        parkDiv.textContent = coaster.Park || 'Unknown Park';
        
        const infoDiv = document.createElement('div');
        infoDiv.className = 'coaster-info';
        
        const manufacturerSpan = document.createElement('span');
        manufacturerSpan.textContent = coaster.Manufacteuer || 'Unknown';
        
        const modelSpan = document.createElement('span');
        modelSpan.textContent = coaster.Model || '';
        
        infoDiv.appendChild(manufacturerSpan);
        infoDiv.appendChild(modelSpan);
        
        // Assemble the card
        detailsDiv.appendChild(nameDiv);
        detailsDiv.appendChild(parkDiv);
        detailsDiv.appendChild(infoDiv);
        
        card.appendChild(imageDiv);
        card.appendChild(detailsDiv);
        
        coasterGrid.appendChild(card);
    });
}

// Filter coasters based on search input and dropdown selections
function filterCoasters() {
    const searchTerm = searchInput.value.toLowerCase();
    const selectedPark = parkFilter.value;
    const selectedManufacturer = manufacturerFilter.value;
    
    const filteredCoasters = allCoasters.filter(coaster => {
        // Check if the coaster matches the search term
        const matchesSearch = !searchTerm || 
            (coaster.Name && coaster.Name.toLowerCase().includes(searchTerm)) || 
            (coaster.Park && coaster.Park.toLowerCase().includes(searchTerm));
        
        // Check if the coaster matches the selected park
        const matchesPark = !selectedPark || coaster.Park === selectedPark;
        
        // Check if the coaster matches the selected manufacturer
        const manufacturer = coaster.Manufacteuer || '';
        const matchesManufacturer = !selectedManufacturer || manufacturer === selectedManufacturer;
        
        return matchesSearch && matchesPark && matchesManufacturer;
    });
    
    // Display the filtered coasters
    displayCoasters(filteredCoasters);
}
</script>
